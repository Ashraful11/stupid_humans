rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Verify App Check token for additional security
    function hasValidAppCheck() {
      return request.auth.token.firebase.sign_in_provider != null;
    }

    // Blog posts - Public read, admin write
    match /posts/{postId} {
      allow read: if true; // Public can read
      allow write: if isAdmin(); // Only admins can write
    }

    // News articles - Public read, admin write
    match /news/{newsId} {
      allow read: if true; // Public can read
      allow write: if isAdmin(); // Only admins can write
    }

    // Tutorials - Public read, admin write
    match /tutorials/{tutorialId} {
      allow read: if true; // Public can read
      allow write: if isAdmin(); // Only admins can write
    }

    // Newsletter subscribers - Create only (no read/update/delete)
    match /subscribers/{email} {
      allow create: if request.resource.data.email is string &&
                       request.resource.data.email.matches('.*@.*\\..*'); // Valid email format
      allow read, update, delete: if isAdmin();
    }

    // Contact form submissions - Create only
    match /contacts/{contactId} {
      allow create: if request.resource.data.keys().hasAll(['name', 'email', 'message']) &&
                       request.resource.data.email.matches('.*@.*\\..*');
      allow read, delete: if isAdmin();
    }

    // Admin users list - Only admins can read/write
    match /admins/{userId} {
      allow read, write: if isAdmin();
    }

    // User profiles - Users can only access their own
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId);
    }

    // Analytics data - Admin only
    match /analytics/{document=**} {
      allow read, write: if isAdmin();
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
